<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luna Wedding — June 5, 2026</title>

  <!-- Social Sharing -->
  <meta property="og:title" content="Luna Wedding — June 5, 2026" />
  <meta property="og:description" content="Luna Wedding — RSVP • June 5, 2026" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://luna.wedding" />
  <meta property="og:image" content="/assets/og.jpg?v=18" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Luna Wedding — June 5, 2026" />
  <meta name="twitter:description" content="Luna Wedding — RSVP • June 5, 2026" />
  <meta name="twitter:image" content="/assets/og.jpg?v=18" />

  <!-- Performance -->
  <link rel="preload" as="image" href="assets/bg.jpg?v=18" fetchpriority="high">
  <link rel="preload" as="image" href="assets/image.jpg?v=18">
  <!-- audio created in JS (no <audio> tag) -->

  <style>
    :root { --fallback:#000; --hint-bg: rgba(255,255,255,.92); --hint-fg:#111; }
    html,body{
      height:100%; margin:0; background:var(--fallback); overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    /* Page animations (kept) */
    @keyframes fadeBg { from {opacity:0} to {opacity:1} }
    @keyframes fadeCard { from {opacity:0; transform:translate(-50%,-48%) scale(.985)} to {opacity:1; transform:translate(-50%,-50%) scale(1)} }
    @keyframes hintIn { from {opacity:0; transform:translate(-50%,-46%)} to {opacity:1; transform:translate(-50%,-40%)} }
    @keyframes hintOut { to {opacity:0; transform:translate(-50%,-36%)} }

    .bg { position:fixed; inset:0; opacity:0; animation:fadeBg 900ms ease-out .05s forwards; }
    .bg img { width:100vw; height:100vh; object-fit:cover; object-position:center; user-select:none; -webkit-user-drag:none; }

    .invite{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(92vw,900px); max-height:88vh; height:auto; border-radius:12px; background:#fff;
      box-shadow:0 20px 48px rgba(0,0,0,.25);
      opacity:0; animation:fadeCard .75s cubic-bezier(.21,.98,.25,.99) .2s forwards;
      cursor:zoom-in; user-select:none; -webkit-user-drag:none; z-index:1;
    }

    .hint{
      position:fixed; left:50%; top:calc(50% + min(50vh, 460px));
      transform:translate(-50%,-40%); padding:8px 12px; border-radius:999px;
      background:var(--hint-bg); color:var(--hint-fg); font-size:13px;
      box-shadow:0 8px 24px rgba(0,0,0,.18); opacity:0; animation:hintIn .5s ease .8s forwards;
      pointer-events:none; z-index:2;
    }
    .hint.hide{ animation:hintOut .35s ease forwards; }

    .lightbox{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; z-index:10;
      transition:opacity 280ms ease, background-color 180ms ease;
      -webkit-backdrop-filter: blur(8px) saturate(120%); backdrop-filter: blur(8px) saturate(120%);
    }
    .lightbox.visible{ opacity:1; pointer-events:auto; }
    .lightbox.closing{ background:rgba(0,0,0,.95); }
    .lightbox img{
      max-width:94vw; max-height:92vh; border-radius:14px; box-shadow:0 24px 64px rgba(0,0,0,.6);
      transform:scale(.96); transition:transform 280ms cubic-bezier(.23,1,.32,1); touch-action:pinch-zoom;
    }
    .lightbox.visible img{ transform:scale(1); }
    .lightbox.closing img{ transform:scale(.98); }
    .close{
      position:fixed; top:calc(12px + env(safe-area-inset-top)); right:calc(12px + env(safe-area-inset-right));
      width:44px; height:44px; border:0; border-radius:999px; background:#fff; color:#000; font-size:22px; line-height:1; cursor:pointer;
      opacity:0; transform:scale(.85); transition:opacity 260ms ease .1s, transform 260ms ease .1s;
    }
    .lightbox.visible .close{ opacity:1; transform:scale(1); }

    .music{
      position:fixed; left:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
      border-radius:999px; border:1px solid rgba(255,255,255,.5);
      background:rgba(0,0,0,.40); color:#fff; font-size:14px;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      box-shadow:0 8px 24px rgba(0,0,0,.18); cursor:pointer; user-select:none;
      transition:opacity .25s ease, transform .25s ease, background .25s ease; z-index:20;
    }
    .music:hover{ transform:translateY(-1px); background:rgba(0,0,0,.5); }
    .music .dot{ width:8px; height:8px; border-radius:999px; background:#ff4d4f; }
    .music.on .dot{ background:#3bd16f; }
    .music .label{ letter-spacing:.2px; }
    .music.error{ opacity:.85; cursor:not-allowed; border-style:dashed; }
    .music.error .label::after{ content:" (not found)"; font-weight:500; }

    @media (prefers-reduced-motion: reduce){ .bg, .invite, .hint{ animation-duration:.01s; } }
  </style>
</head>
<body>
  <!-- Background -->
  <div class="bg" aria-hidden="true">
    <img src="assets/bg.jpg?v=18" alt="">
  </div>

  <!-- Invitation -->
  <img id="invite" class="invite" src="assets/image.jpg?v=18" alt="Wedding invitation">

  <!-- Hint -->
  <div id="hint" class="hint" aria-hidden="true">Tap to zoom</div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-modal="true">
    <img id="lbimg" alt="Wedding invitation (zoomed)">
    <button class="close" aria-label="Close">×</button>
  </div>

  <!-- Music button -->
  <button id="music" class="music" aria-pressed="false" aria-label="Toggle music">
    <span class="dot" aria-hidden="true"></span><span class="label">Music</span>
  </button>

  <noscript><style>.hint{display:none}</style></noscript>

  <script>
    (function(){
      const invite = document.getElementById('invite');
      const hint = document.getElementById('hint');
      const lb = document.getElementById('lightbox');
      const lbimg = document.getElementById('lbimg');
      const closeBtn = lb.querySelector('.close');
      const musicBtn = document.getElementById('music');

      /* ---------- Lightbox ---------- */
      function openLB(){
        lbimg.src = invite.src;
        lb.classList.add('visible');
        document.body.style.overflow = 'hidden';
        if (hint) hint.classList.add('hide');
        ensureAudible(); // gesture for iOS
      }
      function closeLB(){
        lb.classList.add('closing');
        setTimeout(()=>{ lb.classList.remove('visible');
          setTimeout(()=>{ lb.classList.remove('closing'); document.body.style.overflow=''; }, 300);
        },120);
      }
      invite.addEventListener('click', openLB, {passive:true});
      let lastTap=0;
      invite.addEventListener('touchend', e=>{
        const now=Date.now(); if(now-lastTap<300) openLB(); lastTap=now;
      }, {passive:true});
      lb.addEventListener('click', e=>{ if(e.target===lb) closeLB(); });
      closeBtn.addEventListener('click', closeLB);
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeLB(); });

      /* ---------- Audio: robust path detection ---------- */
      const paths = [
        '/assets/bgm_small.mp3?v=18',
        'assets/bgm_small.mp3?v=18',
        '/assets/bgm_small.mp3',
        'assets/bgm_small.mp3'
      ];
      let bgm = null, chosen = null, triedAutoplay = false;

      function setBtn(state){
        musicBtn.classList.toggle('on', state === 'on');
        musicBtn.setAttribute('aria-pressed', state === 'on' ? 'true' : 'false');
      }
      let pref = localStorage.getItem('music') || 'on';
      setBtn(pref);

      async function resolveAudioSrc(){
        for (const p of paths) {
          try {
            const res = await fetch(p, { method:'HEAD', cache:'no-store' });
            if (res.ok) { chosen = p; return p; }
          } catch(e){ /* try next */ }
        }
        return null;
      }

      async function createAudio(){
        if (bgm) return bgm;
        if (!chosen) await resolveAudioSrc();
        if (!chosen) {
          musicBtn.classList.add('error');
          musicBtn.title = 'Audio file not found in /assets';
          return null;
        }
        bgm = new Audio();
        bgm.src = chosen;
        bgm.loop = true;
        bgm.preload = 'auto';
        bgm.playsInline = true;  // iOS
        bgm.muted = true;        // allow autoplay
        bgm.volume = 0.35;       // fixed volume (no JS fade)
        const p = bgm.play();
        if (p && typeof p.catch === 'function') p.catch(()=>{});
        triedAutoplay = true;
        return bgm;
      }

      function ensureAudible(){
        createAudio().then(a=>{
          if (!a) return;
          a.muted = false;
          if (a.paused) a.play().catch(()=>{});
        });
      }

      // First pointer anywhere enables sound
      window.addEventListener('pointerdown', ensureAudible, { once:true, passive:true });

      // Music toggle with remembered preference
      musicBtn.addEventListener('click', ()=>{
        if (musicBtn.classList.contains('error')) return;
        pref = (pref === 'on') ? 'off' : 'on';
        localStorage.setItem('music', pref);
        setBtn(pref);
        createAudio().then(a=>{
          if (!a) return;
          if (pref === 'on'){
            a.muted = false;
            if (a.paused) a.play().catch(()=>{});
            a.volume = 0.35;
          } else {
            a.muted = true;
          }
        });
      });

      // Create audio on load so it can buffer silently
      window.addEventListener('load', ()=>{ createAudio(); });

      // Hide hint after a moment
      setTimeout(()=>{ if (hint) hint.classList.add('hide'); }, 2500);
    })();
  </script>
</body>
</html>
